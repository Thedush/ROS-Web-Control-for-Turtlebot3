<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<link rel="stylesheet" href="./css/style.css">

<canvas id="myCanvas" width=300 height=300></canvas>

<script type="text/javascript" src="http://cdn.robotwebtools.org/EventEmitter2/current/eventemitter2.min.js"></script>
<script type="text/javascript" src="http://cdn.robotwebtools.org/roslibjs/current/roslib.min.js"></script>

<script type="text/javascript" type="text/javascript">

// This function connects to the rosbridge server running on the local computer on port 9090
var rbServer = new ROSLIB.Ros({
    url : 'ws://localhost:9090'
 });

 // This function is called upon the rosbridge connection event
 rbServer.on('connection', function() {
     // Write appropriate message to #feedback div when successfully connected to rosbridge
     var fbDiv = document.getElementById('feedback');
     fbDiv.innerHTML += "<p>Connected to Robot Operation System Server</p>";
 });

// This function is called when there is an error attempting to connect to rosbridge
rbServer.on('error', function(error) {
    // Write appropriate message to #feedback div upon error when attempting to connect to rosbridge
    var fbDiv = document.getElementById('feedback');
    fbDiv.innerHTML += "<p>Error connecting to websocket server</p>";
});

// This function is called when the connection to rosbridge is closed
rbServer.on('close', function() {
    // Write appropriate message to #feedback div upon closing connection to rosbridge
    var fbDiv = document.getElementById('feedback');
    fbDiv.innerHTML += "<p>Connection to websocket server closed</p>";
 });

// These lines create a topic object as defined by roslibjs
var cmdVelTopic = new ROSLIB.Topic({
    ros : rbServer,
    name : '/cmd_vel',
    messageType : 'geometry_msgs/Twist'
});

// These lines create a message that conforms to the structure of the Twist defined in our ROS installation
// It initalizes all properties to zero. They will be set to appropriate values before we publish this message.
var twist = new ROSLIB.Message({
    linear : {
        x : 0.0,
        y : 0.0,
        z : 0.0
    },
    angular : {
        x : 0.0,
        y : 0.0,
        z : 0.0
    }
});

var odomTopic = new ROSLIB.Topic({
    ros : rbServer,
    name : '/odom',
    messageType : 'nav_msgs/Odometry'
});

odomTopic.subscribe(function(message) {
    var poseLinVel = document.getElementById('poseLinVel');
    poseLinVel.innerHTML  = "LinVel = " + message.twist.twist.linear.x
    var poseAngVel = document.getElementById('poseAngVel');
    poseAngVel.innerHTML  = "AngVel = " + message.twist.twist.angular.z
});

var poseTopic = new ROSLIB.Topic({
    ros : rbServer,
    name : '/pose2d',
    messageType : 'geometry_msgs/Pose2D'
});

var targetTopic = new ROSLIB.Topic({
    ros : rbServer,
    name : '/target',
    messageType : 'geometry_msgs/Pose2D'
});

var pose2D = new ROSLIB.Message({
    x : 0.0,
    y : 0.0,
    theta : 0.0
});

function sleep(delay) {
    var start = new Date().getTime();
    while (new Date().getTime() < start + delay);
}

function map(x, in_min, in_max, out_min, out_max) {
    return (x - in_min) * (out_max - out_min) / (in_max - in_min) + out_min;
}

function moveSomeWhere(linVel, angVel) {
    twist.linear.x = linVel;
    twist.angular.z = angVel;
    
    cmdVelTopic.publish(twist);
}
//This block go to target
function goToPoint(tarX, tarY) {
    pose2D.x = tarX;
    pose2D.y = tarY;
    
    targetTopic.publish(pose2D);
}
//This block is definition of canvas
var elem = document.getElementById('myCanvas'),
    elemLeft = elem.offsetLeft,
    elemTop = elem.offsetTop,
    context = elem.getContext('2d');

// This block click event block in canvas
elem.addEventListener('click', function(event) {
    var mouseX = -300/2 + event.pageX - elemLeft;
    var mouseY = 300/2 - event.pageY + elemTop;
    mouseX = map(mouseX, 0, 300, 0, 30)
    mouseY = map(mouseY, 0, 300, 0, 30)
    var mouseClick1 = document.getElementById('mouseClick');
    mouseClick1.innerHTML  = mouseX + "," + mouseY

    goToPoint(mouseX, mouseY)
    
}, false);

//this block subscriber block
poseTopic.subscribe(function(message) {
    var my_PoseX = message.x
    var my_PoseY = message.y
    var my_Theta = message.theta
    var poseX = document.getElementById('poseX');
    poseX.innerHTML  = "X = " + my_PoseX
    var poseY = document.getElementById('poseY');
    poseY.innerHTML  = "Y = " + my_PoseY
    var poseTheta = document.getElementById('poseTheta');
    poseTheta.innerHTML  = "Theta = " + my_Theta
    
    //this block draw black line
    var drawX = 300/2 + message.x*300/30 
    var drawY = 300/2 - message.y*300/30 
    context.fillStyle = "#09ff00";
    context.moveTo(drawX,drawY);
    context.lineTo(drawX+1,drawY+1);
    context.stroke();
    //this block drav triangle
});
//This functions are basic cmd_vel_control blocks
function goforward() {
    moveSomeWhere(0.5, 0)
    sleep(100)
    moveSomeWhere(0, 0)
}
function gobackward() {
    moveSomeWhere(-0.5, 0)
    sleep(100)
    moveSomeWhere(0, 0)
}
function turnright() {
    moveSomeWhere(0, -0.5)
    sleep(100)
    moveSomeWhere(0, 0)
}
function turnleft() {
    moveSomeWhere(0, 0.5)
    sleep(100)
    moveSomeWhere(0, 0)
}
</script>

</head>
<body>
<div class="KezbotOpenMessage">
<b>Ankara University Kezbot Version 2.0.0 Command Control Center</b>
</div>
<form id="c2356" >
<div class="ButtonForm">
<button class="UpButton" type="button" ="Up" onclick="goforward()">Up</button>
<button class="DownButton" type="button" ="Up" onclick="gobackward()">Down</button>
<button class="LeftButton" type="button" ="Up" onclick="turnleft()">Left</button>
<button class="RightButton" type="button" ="Up" onclick="turnright()">Right</button>
</div>
</form>
<div class="PoseX" id="poseX"></div>
<div class="PoseY" id="poseY"></div>
<div class="PoseLinVel" id="poseLinVel"></div>
<div class="PoseTheta" id="poseTheta"></div>
<div class="feedbackText" id="feedback"></div>
<div class="PoseAngVel" id="poseAngVel"></div>
<div class="MouseClick" id="mouseClick">deneme</div>
</body>
<html>
